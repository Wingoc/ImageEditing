<!DOCTYPE html>
<html>
<head>
	<title>图片添加文字</title>

	<link rel="icon" href="./libs/title.ico" type="image/x-icon">
	<!-- <meta http-equiv="X-UA-Compatible" content="IE=9"> -->
	<!-- <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=yes, width=device-width"> -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0, width=device-width">
	<style type="text/css">
	html,body{
		-webkit-touch-callout:none;
		-webkit-text-size-adjust:none;
		-webkit-tap-highlight-color:transparent;
		-webkit-user-select:none;
	}
	</style>
	<link href="./libs/bootstrap.min.css" rel="stylesheet">
	<script src="./libs/jquery.min.js"></script>
</head>
<body>
	<canvas id="shuiyinTest" width="460.8" height="259.2"></canvas>
	<img id="img_show" src="" style="display: none;" />

    <div style="text-align: center;">
    	<span class="importBtn">       
    		<!-- <input type="button" class="btn btn-default" id="fileReader" value="打开"/> -->
    		<button id="fileReader" class="btn btn-primary" style="font-weight: bold; width: 200px;" type="button">打开</button>
    		<input type="file" id="file" style="display: none;" onchange="uploadPicture(this)">
    	</span>
    </div>

    <div style="text-align: center; margin-top: 10px;">
    	<button id="shuiyinBtn" class="btn btn-success" type="button">点击添加文字</button>
    	<button id="download" class="btn btn-success" type="button">确认添加</button>
    </div>
    <div style="text-align: center; margin-top: 10px;">
    	<textarea id="shuiyinText" rows="8" cols="36">[河苑]喜'阅'新一代亲子共读活动打卡第2天，今天我们阅读了《绿山墙的安妮》P21~P50。
		</textarea>
    </div>
    
	



	<script type="text/javascript">

		var img_url = "";

		function shuiyin(canvasid,imgurl,addtext){

			var img = new Image;
			img.src = imgurl;
			img.onload = function(){
				var canvas = document.getElementById(canvasid);
				console.log(canvas.width);
				console.log(canvas.height);
				console.log(img.width);
				console.log(img.height);
				var ctx = canvas.getContext("2d");
				ctx.drawImage(img,0,0,canvas.width,canvas.height);
				ctx.font = "bold 12px 微软雅黑";
				// rgba(30,144,255,0.9)
				ctx.fillStyle = "rgba(30,144,255,0.9)";
				document.getElementById("shuiyinBtn").onclick = function(){
					var addtext = document.getElementById("shuiyinText").value;
					console.log(addtext.length);
					for (var i = 0; i <= addtext.length / 15; i++){
						if ((15+i*15)<addtext.length){
							ctx.fillText(addtext.slice(i*15, 15+i*15), 275, 15+15*i);
						} else{
							ctx.fillText(addtext.slice(i*15, addtext.Length), 275, 15+15*i);
						}
					}
				}
			}
		}


		// upload picture
		document.getElementById("fileReader").onclick = function(){
			document.getElementById("file").click();
		}


		// show canvas
		function uploadPicture(){

			var reads = new FileReader();
			f = document.getElementById("file").files[0];
			reads.readAsDataURL(f);
			reads.onload = function(e){
				img_url = this.result;
				shuiyin("shuiyinTest",img_url);
			}

		}


		// canvas >>> img
		document.getElementById("download").onclick = function(){

			var img_show = document.getElementById("img_show");
			var canvas = document.getElementById("shuiyinTest");
			temp = canvas.toDataURL();
  			img_show.src = temp;
  			canvas.style.display = "none";
  			img_show.style.display = "block";
  			alert("长按图片保存到相册！");
		}

	</script>
</body>
</html>